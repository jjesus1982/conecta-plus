# ============================================
# Conecta Plus - Security Headers Configuration
# ============================================
# Arquivo dedicado para headers de seguranca
# Include em: server block apenas
# ============================================

# Content Security Policy (CSP)
# Politica restritiva mas funcional para Next.js + Tailwind
# ---------------------------------------------------------
# 'self'          - Permite recursos do proprio dominio
# 'unsafe-inline' - Necessario para Tailwind CSS inline styles
# 'unsafe-eval'   - Necessario para Next.js em desenvolvimento
# data:           - Permite data URIs para imagens
# blob:           - Permite blob URIs para workers
# wss:            - Permite WebSocket seguro
# ws:             - Permite WebSocket (dev)

# Header CSP completo - single line para compatibilidade
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: blob: https: http:; connect-src 'self' ws: wss: https://api.* http://localhost:*; frame-src 'self'; frame-ancestors 'self'; object-src 'none'; base-uri 'self'; form-action 'self'; media-src 'self' blob:; worker-src 'self' blob:; manifest-src 'self'; upgrade-insecure-requests" always;

# X-Content-Type-Options
# Previne MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# X-Frame-Options
# Protege contra clickjacking - SAMEORIGIN permite iframes do mesmo dominio
add_header X-Frame-Options "SAMEORIGIN" always;

# X-XSS-Protection
# Ativa filtro XSS do navegador (legado, mas ainda util)
add_header X-XSS-Protection "1; mode=block" always;

# Referrer-Policy
# Controla informacoes enviadas no header Referer
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions-Policy (antigo Feature-Policy)
# Bloqueia recursos nao utilizados para maior seguranca
add_header Permissions-Policy "accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(self), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=()" always;

# Strict-Transport-Security (HSTS)
# NOTA: HSTS esta definido no server block principal em default.conf
# Nao duplicar aqui para evitar conflitos com headers duplicados

# Cross-Origin Headers
# Protecao adicional contra ataques cross-origin
add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Resource-Policy "same-origin" always;
# Cross-Origin-Embedder-Policy comentado pois pode quebrar imagens externas
# add_header Cross-Origin-Embedder-Policy "require-corp" always;
