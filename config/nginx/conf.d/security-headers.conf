# ============================================
# Conecta Plus - Security Headers Configuration
# ============================================
# Arquivo dedicado para headers de seguranca
# Include em: server block apenas
# Atualizado: 2025-12-26 - Migrado para CSP com nonces
# ============================================

# Content Security Policy (CSP)
# ---------------------------------------------------------
# IMPORTANTE: CSP agora e definido pelo Next.js middleware
# O middleware gera nonces dinamicos para cada request, permitindo
# remover 'unsafe-inline' de script-src (mais seguro).
#
# O Next.js adiciona o header CSP com nonce antes de chegar aqui.
# NAO definimos CSP no Nginx para evitar conflitos de headers.
#
# Fluxo: Request -> Next.js Middleware (gera nonce + CSP) -> Response
#
# Ver: /opt/conecta-plus/frontend/src/middleware.ts
# ---------------------------------------------------------

# CSP REMOVIDO - Agora gerenciado pelo Next.js middleware com nonces
# add_header Content-Security-Policy "..." always;

# CSP alternativo ESTATICO (fallback se Next.js nao definir)
# Usado apenas para assets estaticos que nao passam pelo middleware
# NOTA: Nginx proxy_hide_header pode ser usado para remover CSP do upstream
#       e adicionar um proprio, mas preferimos deixar o Next.js gerenciar

# X-Content-Type-Options
# Previne MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# X-Frame-Options
# Protege contra clickjacking - SAMEORIGIN permite iframes do mesmo dominio
add_header X-Frame-Options "SAMEORIGIN" always;

# X-XSS-Protection
# Ativa filtro XSS do navegador (legado, mas ainda util)
add_header X-XSS-Protection "1; mode=block" always;

# Referrer-Policy
# Controla informacoes enviadas no header Referer
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions-Policy (antigo Feature-Policy)
# Bloqueia recursos nao utilizados para maior seguranca
add_header Permissions-Policy "accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(self), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=()" always;

# Strict-Transport-Security (HSTS)
# NOTA: HSTS esta definido no server block principal em default.conf
# Nao duplicar aqui para evitar conflitos com headers duplicados

# Cross-Origin Headers
# Protecao adicional contra ataques cross-origin
add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Resource-Policy "same-origin" always;
# Cross-Origin-Embedder-Policy comentado pois pode quebrar imagens externas
# add_header Cross-Origin-Embedder-Policy "require-corp" always;
